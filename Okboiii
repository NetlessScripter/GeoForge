pl=game.Players.LocalPlayer
rs=game:GetService("RunService")

c=nil
hrp=nil
h=nil

maxY=0
rag=false
locked=false
cons={}
motors={}
partProps={}
orig={}
ragStart=0

thresh=40
RAG_TIME=4.1

function ch()
	c=pl.Character or pl.CharacterAdded:Wait()
	hrp=c:WaitForChild("HumanoidRootPart")
	h=c:WaitForChild("Humanoid")
	maxY=hrp.Position.Y
end

function grab()
	motors={}
	for _,v in c:GetDescendants() do
		if v:IsA("Motor6D") and v.Part0 and v.Part1 then
			motors[#motors+1]=v
		end
	end
end

function storeProps()
	partProps={}
	for _,v in c:GetDescendants() do
		if v:IsA("BasePart") then
			partProps[#partProps+1]={v,v.CustomPhysicalProperties,v.Anchored}
		end
	end
end

function applyPhys()
	for i=1,#partProps do
		v=partProps[i][1]
		v.CanCollide=true
		v.Massless=false
		pcall(function()
			v.CustomPhysicalProperties=PhysicalProperties.new(0.98,0.6,0.03,1,1)
		end)
	end
end

function restoreProps()
	for i=1,#partProps do
		v=partProps[i][1]
		pp=partProps[i][2]
		a=partProps[i][3]
		pcall(function() v.CustomPhysicalProperties=pp end)
		v.Anchored=a
	end
end

function lockPose()
	if locked then return end
	for i=1,#cons do
		m=cons[i][1]
		a0=cons[i][2]
		a1=cons[i][3]
		b=cons[i][4]
		if b then b:Destroy() end
		if a0 then a0:Destroy() end
		if a1 then a1:Destroy() end
		if m and m.Part0 and m.Part1 then
			w=Instance.new("WeldConstraint")
			w.Part0=m.Part0
			w.Part1=m.Part1
			w.Parent=m.Part0
			cons[i][6]=w
		end
	end
	for i=1,#partProps do
		v=partProps[i][1]
		v.AssemblyLinearVelocity=Vector3.zero
		v.AssemblyAngularVelocity=Vector3.zero
		v.Anchored=true
	end
	locked=true
end

function unlockPose()
	if not locked then return end
	for i=1,#cons do
		w=cons[i][6]
		if w then w:Destroy() end
	end
	for i=1,#partProps do
		partProps[i][1].Anchored=false
	end
	locked=false
end

function ragOn()
	if rag then return end
	rag=true
	locked=false
	ragStart=tick()

	grab()
	storeProps()

	orig.walk=h.WalkSpeed
	orig.jump=h.JumpPower
	orig.auto=h.AutoRotate

	h.WalkSpeed=0
	h.JumpPower=0
	h.PlatformStand=true
	h.AutoRotate=false
	h:ChangeState(Enum.HumanoidStateType.Physics)

	cons={}
	for i=1,#motors do
		m=motors[i]
		a0=Instance.new("Attachment")
		a1=Instance.new("Attachment")
		a0.CFrame=m.C0
		a1.CFrame=m.C1
		a0.Parent=m.Part0
		a1.Parent=m.Part1
		b=Instance.new("BallSocketConstraint")
		b.Attachment0=a0
		b.Attachment1=a1
		b.Parent=m.Part0
		cons[#cons+1]={m,a0,a1,b,m.Parent,nil}
		m.Parent=nil
	end

	applyPhys()

	vel=hrp.AssemblyLinearVelocity
	for i=1,#partProps do
		v=partProps[i][1]
		mass=v.AssemblyMass
		v:ApplyImpulse(vel*mass*0.85)
		v:ApplyAngularImpulse(Vector3.new(
			(math.random()-0.5)*8,
			(math.random()-0.5)*8,
			(math.random()-0.5)*8
		)*mass)
	end
end

function ragOff()
	if not rag then return end
	rag=false
	unlockPose()

	for i=1,#cons do
		m,a0,a1,b,p,w=unpack(cons[i])
		if w then w:Destroy() end
		if b then b:Destroy() end
		if a0 then a0:Destroy() end
		if a1 then a1:Destroy() end
		if m and p then m.Parent=p end
	end
	cons={}

	restoreProps()

	for _,v in c:GetDescendants() do
		if v:IsA("BasePart") then
			v.AssemblyLinearVelocity=Vector3.zero
			v.AssemblyAngularVelocity=Vector3.zero
		end
	end

	h.PlatformStand=false
	h.AutoRotate=orig.auto
	h.WalkSpeed=orig.walk
	h.JumpPower=orig.jump

	h:ChangeState(Enum.HumanoidStateType.Physics)
	task.wait()
	h:ChangeState(Enum.HumanoidStateType.Running)
end

rs.RenderStepped:Connect(function()
	if not hrp then return end
	y=hrp.Position.Y

	if not rag then
		if h.FloorMaterial~=Enum.Material.Air then
			maxY=y
		else
			if y>maxY then maxY=y end
			if maxY-y>=thresh then
				ragOn()
			end
		end
	else
		if tick()-ragStart>=RAG_TIME then
			lockPose()
			task.delay(0.15,ragOff)
		end
	end
end)

pl.CharacterAdded:Connect(function()
	task.wait()
	ch()
end)

ch()
